<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictionary Game - Multiplayer</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0]?.includes?.('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDFlzHW747uu1p1TdqWbdFM_omkjORRht4",
            authDomain: "dictionary-5fae9.firebaseapp.com",
            databaseURL: "https://dictionary-5fae9-default-rtdb.firebaseio.com",
            projectId: "dictionary-5fae9",
            storageBucket: "dictionary-5fae9.firebasestorage.app",
            messagingSenderId: "615496664058",
            appId: "1:615496664058:web:0ea7b1bd792d230cbf1a43"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        const BookOpen = () => (
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
        );

        const Users = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
            </svg>
        );

        const Trophy = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
            </svg>
        );

        const Copy = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        function MultiplayerDictionaryGame() {
            const [view, setView] = useState('home');
            const [gameCode, setGameCode] = useState('');
            const [playerName, setPlayerName] = useState('');
            const [playerId, setPlayerId] = useState(null);
            const [gameData, setGameData] = useState(null);
            const [inputGameCode, setInputGameCode] = useState('');
            const [inputPlayerName, setInputPlayerName] = useState('');
            const [difficulty, setDifficulty] = useState('adult');
            const [currentWord, setCurrentWord] = useState('');
            const [realDefinition, setRealDefinition] = useState('');
            const [myDefinition, setMyDefinition] = useState('');
            const [myVote, setMyVote] = useState(null);
            const [loadingWord, setLoadingWord] = useState(false);
            const gameRef = useRef(null);

            const wordLists = {
                kids: ['canopy', 'whimsy', 'gadget', 'mosaic', 'nimble'],
                teen: ['ambiguous', 'benevolent', 'candor', 'diligent', 'ephemeral'],
                adult: ['absquatulate', 'bumfuzzle', 'callipygian', 'defenestrate', 'kakistocracy']
            };

            const generateGameCode = () => {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            };

            const createGame = async () => {
                const code = generateGameCode();
                const newPlayerId = Date.now().toString();

                await database.ref(`games/${code}`).set({
                    host: newPlayerId,
                    hostName: playerName,
                    state: 'setup',
                    difficulty: 'adult',
                    players: {
                        [newPlayerId]: {
                            name: playerName,
                            score: 0,
                            isHost: true,
                            joinedAt: Date.now()
                        }
                    },
                    createdAt: Date.now()
                });

                setGameCode(code);
                setPlayerId(newPlayerId);
                setView('game');
            };

            const joinGame = async () => {
                if (!inputGameCode || !inputPlayerName) {
                    alert('Please enter both game code and your name');
                    return;
                }

                const code = inputGameCode.toUpperCase();
                const snapshot = await database.ref(`games/${code}`).once('value');

                if (!snapshot.exists()) {
                    alert('Game not found. Check the code and try again.');
                    return;
                }

                const newPlayerId = Date.now().toString();

                await database.ref(`games/${code}/players/${newPlayerId}`).set({
                    name: inputPlayerName,
                    score: 0,
                    isHost: false,
                    joinedAt: Date.now()
                });

                setGameCode(code);
                setPlayerId(newPlayerId);
                setPlayerName(inputPlayerName);
                setView('game');
            };

            useEffect(() => {
                if (gameCode && view === 'game') {
                    gameRef.current = database.ref(`games/${gameCode}`);

                    gameRef.current.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setGameData(data);
                        }
                    });

                    return () => {
                        if (gameRef.current) {
                            gameRef.current.off();
                        }
                    };
                }
            }, [gameCode, view]);

            const getRandomWord = async () => {
                setLoadingWord(true);
                try {
                    let word = null;

                    if (difficulty === 'kids') {
                        const topics = ['animals', 'nature', 'school'];
                        const topic = topics[Math.floor(Math.random() * topics.length)];
                        const response = await fetch(`https://api.datamuse.com/words?topics=${topic}&max=100`);
                        const data = await response.json();

                        if (data && data.length > 0) {
                            const filtered = data.filter(w => w.word.length >= 5 && w.word.length <= 9);
                            if (filtered.length > 0) {
                                word = filtered[Math.floor(Math.random() * Math.min(30, filtered.length))]?.word;
                            }
                        }
                    } else if (difficulty === 'teen') {
                        const response = await fetch('https://api.datamuse.com/words?sp=?????????*&md=f&max=200');
                        const data = await response.json();

                        if (data && data.length > 0) {
                            const filtered = data.filter(w => {
                                const freq = w.tags?.[0]?.replace('f:', '') || '0';
                                return parseFloat(freq) < 20;
                            });
                            if (filtered.length > 0) {
                                word = filtered[Math.floor(Math.random() * filtered.length)]?.word;
                            }
                        }
                    } else {
                        word = wordLists.adult[Math.floor(Math.random() * wordLists.adult.length)];
                    }

                    if (!word) {
                        word = wordLists[difficulty][Math.floor(Math.random() * wordLists[difficulty].length)];
                    }

                    setCurrentWord(word);
                } catch (error) {
                    console.error('Error getting word:', error);
                }
                setLoadingWord(false);
            };

            const startRound = async () => {
                if (!currentWord || !realDefinition) {
                    alert('Please enter word and definition');
                    return;
                }

                await database.ref(`games/${gameCode}`).update({
                    state: 'collecting',
                    currentWord: currentWord,
                    realDefinition: realDefinition,
                    difficulty: difficulty,
                    definitions: {},
                    votes: {},
                    roundStarted: Date.now()
                });
            };

            const submitDefinition = async () => {
                if (!myDefinition.trim()) {
                    alert('Please enter a definition');
                    return;
                }

                await database.ref(`games/${gameCode}/definitions/${playerId}`).set({
                    text: myDefinition.trim(),
                    submittedAt: Date.now()
                });

                setMyDefinition('');
            };

            const startVoting = async () => {
                await database.ref(`games/${gameCode}`).update({
                    state: 'voting'
                });
            };

            const castVote = async (defId) => {
                await database.ref(`games/${gameCode}/votes/${playerId}`).set(defId);
                setMyVote(defId);
            };

            const showResults = async () => {
                const votes = gameData.votes || {};
                const definitions = gameData.definitions || {};
                const players = gameData.players || {};

                const voteCounts = {};
                Object.values(votes).forEach(defId => {
                    voteCounts[defId] = (voteCounts[defId] || 0) + 1;
                });

                const updates = {};

                Object.keys(definitions).forEach(defPlayerId => {
                    if (voteCounts[defPlayerId]) {
                        const currentScore = players[defPlayerId]?.score || 0;
                        updates[`players/${defPlayerId}/score`] = currentScore + voteCounts[defPlayerId];
                    }
                });

                if (voteCounts['real']) {
                    const hostId = gameData.host;
                    const currentScore = players[hostId]?.score || 0;
                    updates[`players/${hostId}/score`] = currentScore + voteCounts['real'];
                }

                updates.state = 'results';
                updates.voteCounts = voteCounts;

                await database.ref(`games/${gameCode}`).update(updates);
            };

            const newRound = async () => {
                await database.ref(`games/${gameCode}`).update({
                    state: 'setup',
                    currentWord: null,
                    realDefinition: null,
                    definitions: null,
                    votes: null,
                    voteCounts: null
                });
                setCurrentWord('');
                setRealDefinition('');
                setMyDefinition('');
                setMyVote(null);
            };

            const copyGameCode = () => {
                navigator.clipboard.writeText(gameCode);
                alert('Game code copied!');
            };

            const isHost = gameData?.host === playerId;
            const players = gameData?.players || {};
            const definitions = gameData?.definitions || {};
            const votes = gameData?.votes || {};

            if (view === 'home') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="flex justify-center mb-4">
                                    <BookOpen />
                                </div>
                                <h1 className="text-3xl font-bold text-purple-900 mb-2">Dictionary Game</h1>
                                <p className="text-gray-600">Multiplayer word bluffing game</p>
                            </div>

                            <div className="space-y-4">
                                <button
                                    onClick={() => setView('host')}
                                    className="w-full px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold text-lg"
                                >
                                    Host New Game
                                </button>

                                <button
                                    onClick={() => setView('join')}
                                    className="w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-lg"
                                >
                                    Join Game
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'host') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <h2 className="text-2xl font-bold text-purple-900 mb-6">Host New Game</h2>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Your Name</label>
                                    <input
                                        type="text"
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        placeholder="Enter your name"
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                </div>

                                <button
                                    onClick={createGame}
                                    disabled={!playerName.trim()}
                                    className="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400"
                                >
                                    Create Game
                                </button>

                                <button
                                    onClick={() => setView('home')}
                                    className="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                >
                                    Back
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'join') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <h2 className="text-2xl font-bold text-purple-900 mb-6">Join Game</h2>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Game Code</label>
                                    <input
                                        type="text"
                                        value={inputGameCode}
                                        onChange={(e) => setInputGameCode(e.target.value.toUpperCase())}
                                        placeholder="Enter 6-digit code"
                                        maxLength="6"
                                        className="w-full px-4 py-2 border rounded-lg uppercase"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2">Your Name</label>
                                    <input
                                        type="text"
                                        value={inputPlayerName}
                                        onChange={(e) => setInputPlayerName(e.target.value)}
                                        placeholder="Enter your name"
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                </div>

                                <button
                                    onClick={joinGame}
                                    disabled={!inputGameCode.trim() || !inputPlayerName.trim()}
                                    className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                                >
                                    Join Game
                                </button>

                                <button
                                    onClick={() => setView('home')}
                                    className="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                >
                                    Back
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'game' && gameData) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-4">
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h1 className="text-2xl font-bold text-purple-900">Dictionary Game</h1>
                                        <p className="text-sm text-gray-600">
                                            {isHost ? 'You are the host' : `Host: ${gameData.hostName}`}
                                        </p>
                                    </div>
                                    <div className="text-right">
                                        <div className="flex items-center gap-2 bg-purple-100 px-4 py-2 rounded-lg">
                                            <span className="font-mono font-bold text-purple-900 text-xl">{gameCode}</span>
                                            <button onClick={copyGameCode} className="text-purple-600 hover:text-purple-800">
                                                <Copy />
                                            </button>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">Share this code</p>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                                <h2 className="text-lg font-semibold mb-3 flex items-center gap-2">
                                    <Users />
                                    Players ({Object.keys(players).length})
                                </h2>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    {Object.entries(players).map(([id, player]) => (
                                        <div key={id} className="flex justify-between items-center bg-purple-50 p-3 rounded">
                                            <span className="font-medium">{player.name}</span>
                                            <span className="flex items-center gap-1 text-purple-700">
                                                <Trophy />
                                                {player.score}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {isHost && gameData.state === 'setup' && (
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                                    <h2 className="text-xl font-semibold mb-4">Setup Round</h2>

                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Difficulty</label>
                                            <select
                                                value={difficulty}
                                                onChange={(e) => setDifficulty(e.target.value)}
                                                className="w-full px-3 py-2 border rounded"
                                            >
                                                <option value="kids">Kids (8-12)</option>
                                                <option value="teen">Teens</option>
                                                <option value="adult">Adults</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-2">Word</label>
                                            <div className="flex gap-2 mb-2">
                                                <input
                                                    type="text"
                                                    value={currentWord}
                                                    onChange={(e) => setCurrentWord(e.target.value)}
                                                    placeholder="Enter word"
                                                    className="flex-1 px-3 py-2 border rounded"
                                                />
                                                <button
                                                    onClick={getRandomWord}
                                                    disabled={loadingWord}
                                                    className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700"
                                                >
                                                    {loadingWord ? 'Loading...' : 'Random'}
                                                </button>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-2">Real Definition</label>
                                            <textarea
                                                value={realDefinition}
                                                onChange={(e) => setRealDefinition(e.target.value)}
                                                placeholder="Enter the real definition"
                                                className="w-full px-3 py-2 border rounded h-24"
                                            />
                                        </div>

                                        <button
                                            onClick={startRound}
                                            className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            Start Collecting Definitions
                                        </button>
                                    </div>
                                </div>
                            )}

                            {!isHost && gameData.state === 'setup' && (
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-4 text-center">
                                    <p className="text-gray-600">Waiting for host to start the round...</p>
                                </div>
                            )}

                            {gameData.state === 'collecting' && (
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                                    <h2 className="text-xl font-semibold mb-2">
                                        {isHost ? 'Definitions Coming In' : 'Submit Your Definition'}
                                    </h2>
                                    <p className="text-gray-600 mb-4">
                                        Word: <span className="font-bold text-lg">{gameData.currentWord}</span>
                                    </p>

                                    {!isHost && !definitions[playerId] && (
                                        <div className="space-y-3">
                                            <textarea
                                                value={myDefinition}
                                                onChange={(e) => setMyDefinition(e.target.value)}
                                                placeholder="Write a fake definition that sounds believable..."
                                                className="w-full px-3 py-2 border rounded h-24"
                                            />
                                            <button
                                                onClick={submitDefinition}
                                                className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                            >
                                                Submit Definition
                                            </button>
                                        </div>
                                    )}

                                    {!isHost && definitions[playerId] && (
                                        <div className="bg-green-50 p-4 rounded">
                                            <p className="text-green-800 font-semibold">✓ Your definition has been submitted!</p>
                                            <p className="text-sm text-green-600 mt-1">Waiting for other players...</p>
                                        </div>
                                    )}

                                    {isHost && (
                                        <div className="space-y-3">
                                            <p className="text-sm text-gray-600">
                                                Definitions received: {Object.keys(definitions).length} / {Object.keys(players).length - 1}
                                            </p>
                                            {Object.keys(definitions).map((defId, idx) => (
                                                <div key={defId} className="bg-gray-50 p-3 rounded">
                                                    <p className="text-sm font-medium text-gray-600">Definition {idx + 1}</p>
                                                    <p className="text-gray-800">{definitions[defId].text}</p>
                                                </div>
                                            ))}
                                            {Object.keys(definitions).length > 0 && (
                                                <button
                                                    onClick={startVoting}
                                                    className="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                                                >
                                                    Start Voting
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {gameData.state === 'voting' && (
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                                    <h2 className="text-xl font-semibold mb-2">Vote for the Real Definition</h2>
                                    <p className="text-gray-600 mb-4">
                                        Word: <span className="font-bold text-lg">{gameData.currentWord}</span>
                                    </p>

                                    {!isHost && (
                                        <div className="space-y-3">
                                            {[...Object.entries(definitions).filter(([id]) => id !== playerId), ['real', { text: gameData.realDefinition }]]
                                                .sort(() => Math.random() - 0.5)
                                                .map(([id, def]) => {
                                                    const voted = myVote === id;
                                                    return (
                                                        <button
                                                            key={id}
                                                            onClick={() => castVote(id)}
                                                            className={`w-full text-left p-4 rounded-lg border-2 transition ${
                                                                voted ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-purple-300'
                                                            }`}
                                                        >
                                                            {def.text}
                                                            {voted && <span className="ml-2 text-green-600 font-semibold">✓ Your vote</span>}
                                                        </button>
                                                    );
                                                })}
                                        </div>
                                    )}

                                    {isHost && (
                                        <div className="space-y-3">
                                            <p className="text-sm text-gray-600">
                                                Votes cast: {Object.keys(votes).length} / {Object.keys(players).length - 1}
                                            </p>
                                            {Object.keys(votes).length >= Object.keys(players).length - 1 && (
                                                <button
                                                    onClick={showResults}
                                                    className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                                >
                                                    Show Results
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {gameData.state === 'results' && (
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                                    <h2 className="text-xl font-semibold mb-4">Round Results</h2>

                                    <div className="mb-6 p-4 bg-green-50 rounded-lg">
                                        <h3 className="font-semibold text-green-900 mb-2">Real Definition:</h3>
                                        <p className="text-gray-800">{gameData.realDefinition}</p>
                                        <p className="text-sm text-green-700 mt-2">
                                            Votes: {gameData.voteCounts?.real || 0}
                                        </p>
                                    </div>

                                    <div className="space-y-3 mb-6">
                                        <h3 className="font-semibold">Player Definitions:</h3>
                                        {Object.entries(definitions).map(([defId, def]) => {
                                            const playerInfo = players[defId];
                                            const voteCount = gameData.voteCounts?.[defId] || 0;
                                            return (
                                                <div key={defId} className="p-4 bg-purple-50 rounded-lg">
                                                    <p className="font-semibold text-purple-900">{playerInfo?.name}'s definition:</p>
                                                    <p className="text-gray-800 mt-1">{def.text}</p>
                                                    <p className="text-sm text-purple-700 mt-2">Votes: {voteCount}</p>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {isHost && (
                                        <button
                                            onClick={newRound}
                                            className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                        >